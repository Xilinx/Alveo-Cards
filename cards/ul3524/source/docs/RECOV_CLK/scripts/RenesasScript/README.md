<table class="sphinxhide" width="100%">
 <tr width="100%">
    <td align="center"><img src="https://raw.githubusercontent.com/Xilinx/Image-Collateral/main/xilinx-logo.png" width="30%"/><h1>UL3524 Ultra Low Latency Trading</h1>
    </td>
 </tr>
</table>

# Renesas Programming Conversion Script
The Renesas jitter cleaner device provides numerous capabilities and options which can be enabled via a large number of registers.  Understanding and re-configuring the device through these registers in the correct sequence can be complicated and error prone. Renesas, however, has a tool to generate the programming sequence as a simple text file.  

Since this file is not directly usable in the reference design, this Perl script converts the Renesas generated text file into a BRAM COE file (or Tcl script) which can be used by this reference design.

This section provides an overview the:
* Renesas generated text file, 
* Details on the Perl conversion script along with 
* Example use cases.

## Renesas Programming Conversion Script Format
A sample segment of the Renesas programming script generated by the Renesas tool is shown below.  It is in text format and provides the programming sequence with each line consisting of the byte length, address offset, and write data to be programmed.  All numbers are assumed to be in hex format.  

```bash
########################################
# I2C, OneByteAddresses
# ClockMatrix (31.2)
# 4/4/2023 2:27:07 PM
########################################

Size: 0x4, Offset: FC, Data: 0x00C01020
Size: 0x9, Offset: 92, Data: 0x0007002D3101000000
Size: 0x12, Offset: 9B, Data: 0x00000000000000000000942369DC02FFFF00
Size: 0x2, Offset: AD, Data: 0x008E
Size: 0xE, Offset: AF, Data: 0x40800CB19A090000010200000000
Size: 0x2, Offset: BD, Data: 0x0000
```

Write data is transferred left to right.  For example, the following sequence...

```bash
Size: 0x4, Offset: FC, Data: 0x00C01020
```

is sent in this byte order: (assumes 0xB0 is Device ID)

| Device ID | Addr | D0 | D1 | D2 | D3 | 
| :---: | :---: | :---: | :---: | :---: | :---: |
| B0 | FC | 00 | C0 | 10 | 20 |

## Programming the Renesas Device
**A quick background on how the provided reference design programs the Renesas device.**

The reference design uses a BRAM and I2C controller to handle the Renesas I2C programming. The BRAM is loaded during synthesis via a COE file or is loaded dynamically via HwMgr's Tcl console.  Once the BRAM is loaded, the user can launch the I2C controller to transfer the contents of the BRAM.

Each BRAM entry consists of a 16-bit word containing a descriptor OpCode byte(15:8) and data byte(7:0).  The opcodes are described in the following table:

| OpCode | Name | Descrption |
| ---- | ---- | ---- |
| 0x01 | DEV_ID_OP | I2C 8-bit Device ID |
| 0x02 | SIZE_OP | (Currently Not Used) |
| 0x04 | ADDR_OP | Address Byte.  Indicates start of I2C sequence. |
| 0x08 | WDATA_OP | Write Data Byte |
| 0x10 | WDATA_LAST_OP | Write Data Byte.  Indicates last byte of I2C sequence. |
| 0x20 | RDATA_OP | (Currently Not Used) |
| 0x80 | FINISHED_OP | Indicates complete sequence is complete. |

## Script Usage
The 'txt_to_mem.pl' is a Perl based translator script that converts the Renesas text file to the COE and Tcl scripts.  The basic usage is as follows:

```bash
perl ./txt_to_mem.pl -i <input txt file> -o <output coe file> -id <target device ID (0x format)>
```

Below are a couple examples...

```bash
./txt_to_mem.pl -i  seq_example.txt \
                -o  seq_example \
                -id 0xB0
                
./txt_to_mem.pl -i  RC38612_20221006_094953_programming_161MHz_to_100MHz_config13_v2.txt \
                -o  RC38612_20221006_094953_programming_161MHz_to_100MHz_config13_v2 \
                -id 0xB0
```

## Output COE File Format
The script will generate a COE file which will look similar to the following example.  This file can be pre-loaded into the BRAM using Vivado before synthesis.  This example sets the Dev ID to 0xB0, sets the starting address to 0xFC, transfers data bytes 0x00, 0xc0, 0x10, 0x20 (last byte), and indicates the end of sequence (0x80FF) 

```bash
memory_initialization_radix=16;
memory_initialization_vector=
01b0,
0204,
04fc,
0800,
08c0,
0810,
1020,
80ff;
```

## Output TCL File Format
Alternately, the script will also generate a Tcl file which can be used to load the BRAM dynamically in HwMgr. This allows the user to try multiple programming sequences without having to rebuild the design. The generated Tcl example programs the same sequence as above.  The 'hwchk_axil_write' function is one of the design's HwMgr helper functions to do a register write to the design via the JTAG/AXI interface.  Note that each line is written as a 32-bit value, but only the lower 16-bits are used.

```bash
hwchk_axil_write 0x00030000 0x00000000 0x000001b0
hwchk_axil_write 0x00030000 0x00000004 0x00000204
hwchk_axil_write 0x00030000 0x00000008 0x000004fc
hwchk_axil_write 0x00030000 0x0000000c 0x00000800
hwchk_axil_write 0x00030000 0x00000010 0x000008c0
hwchk_axil_write 0x00030000 0x00000014 0x00000810
hwchk_axil_write 0x00030000 0x00000018 0x00001020
hwchk_axil_write 0x00030000 0x00000020 0x000080ff
```

## Output LOG and REG File Formats
(These files are still in development and may not be fully accurate)
The generated LOG file provides a humanized description of the generated COE and Tcl files to help with debug.

```bash
instru[000]  = { DEV_ID_OP     , 2'hb0 };
instru[001]  = { SIZE_OP       , 2'h04 };
instru[002]  = { ADDR_OP       , 2'hfc };
instru[003]  = { WDATA_OP      , 2'h00 };
instru[004]  = { WDATA_OP      , 2'hc0 };
instru[005]  = { WDATA_OP      , 2'h10 };
instru[006]  = { WDATA_LAST_OP , 2'h20 };
instru[007]  = { FINISHED_OP   , 8'hff };
```

The generated REG file provides another humanized description that attempts to provide register names based on Renesas documentation.  The scripts will often write across gaps in the register map rather than restart a new sequence, so some addresses may be unknown or not specifically named.

```bash
[fc] Set Page Addr... 0xc000
[00fc] unknown - may be an extension
     [00fc]  0x00  PAGE_ADDR[7:0]
     [00fd]  0xc0  PAGE_ADDR[15:8]
     [00fe]  0x10  PAGE_ADDR[23:16]
     [00ff]  0x20  PAGE_ADDR[31:24]
[c023] unknown - may be an extension
     [c023]  0x00  RESERVED
     [c024]  0x81  GENERAL_STATUS.MAJ_REL Major release number.
     [c025]  0x10  GENERAL_STATUS.MIN_REL Minor release number.
     [c026]  0x20  GENERAL_STATUS.HOTFIX_REL Hotfix release number.
[c060] unknown - may be an extension
     [c060]  0x11  STATUS.DPLL2_REF_STAT DPLL 2 input reference status.
     [c061]  0x22  STATUS.DPLL3_REF_STAT DPLL 3 input reference status.
     [c062]  0x33  STATUS.DPLL4_REF_STAT DPLL 4 input reference status.
```

## Support
For additional documentation, please refer to the [UL3524 product page](https://www.xilinx.com/products/boards-and-kits/alveo/ul3524.html) and the [UL3524 Lounge](https://www.xilinx.com/member/ull-ea.html).

For support, contact your FAE or refer to support resources at: https://support.xilinx.com

<p class="sphinxhide" align="center"><sub>Copyright © 2020–2023 Advanced Micro Devices, Inc</sub></p>

<p class="sphinxhide" align="center"><sup><a href="https://www.amd.com/en/corporate/copyright">Terms and Conditions</a></sup></p>
